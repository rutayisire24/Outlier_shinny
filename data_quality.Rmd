---
title: "Data Quality Report"
output:
  pdf_document:
    extra_dependencies: ["longtable","float"]
    latex_engine: xelatex
date: "`r Sys.Date()`"
params:
  district: NA
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
```

## Data Quality `r params$district` 

This is an automated report highlighting Facilities and the possible data elements that could be outliers that need to be verified. 

```{r}
library(tidyverse)
library(flextable)
library(readr)
library(here)
library(gsheet)

#data <- read_rds("impute.rds")

data <- gsheet2tbl('https://drive.google.com/open?id= 1wewNRiECpefjBjhtaS4Mlp5mnhTpYDa8SiF1agcs4Kk')

table <- data %>%
      group_by(facility,flag)  %>%
      count() %>%
      pivot_wider(names_from = flag,values_from = n) %>%
      rowwise() %>%
      mutate(total = sum(None,Outlier),
             Percentage_outliers = round(Outlier/total*100))%>%
      select(-None) %>%
      filter(Outlier > 0) %>%
    dplyr::arrange(desc(Outlier)) %>%
      rename(
        `Possible Outliers` = Outlier,
        `Total Records` = total, 
        `% Outliers` = Percentage_outliers) 

facilites <- unique(table$facility)

```

## Facilties with the highest counts of Possible Outliers
```{r}

plot_data <- data %>%
      group_by(facility,flag)  %>%
      count() %>%
      pivot_wider(names_from = flag,values_from = n) %>%
      rowwise() %>%
      mutate(total = sum(None,Outlier),
             Percentage_outliers = round(Outlier/total*100))%>%
      select(-None) %>%
      filter(Outlier > 0) %>%
      dplyr::arrange(desc(Outlier))  
  
plot_data %>%
  ungroup() %>%
  slice_max(Outlier,n=10)%>%
      ggplot(aes(x  = reorder(facility,Outlier),y = Outlier))+
      geom_col(fill = "#264653")+
  coord_flip()+
  labs(x = "", y = "Counts")+
  theme_bw()
  
```


### Summary of Facilities that have possible Outliers
There was a total of `r length(facilites)` with possible outlines as seen below; 


```{r}
ft <- flextable(table)
ft <- autofit(ft)
theme_vanilla(ft)


```


## Breakdown of the Possible Outliers per Facility 
```{r}

sum <- data %>%
      ungroup() %>%
      filter(flag == "Outlier") %>%
      select(-c(flag,region,district)) %>%
      relocate(indicator , .before = period) %>%
      dplyr::arrange(desc(period)) %>%
      rename(
        `Suggested Imputation` = variable_clean,
        `Possible Outlier` = variable,
        `Data Element` = indicator,
        Month = period)

# kt <- flextable(sum)
# kt <- autofit(kt)
# theme_vanilla(kt)

knitr::kable(sum) %>%
  kableExtra::kable_styling(latex_options = c("scale_down", "HOLD_position"))
```


